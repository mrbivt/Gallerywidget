<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình Chiếu Ảnh Trước và Sau với Firebase</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: auto;
            background-color: #f0f0f0;
            margin: 0;
            flex-direction: column;
        }

        .slider-container {
            position: relative;
            width: 640px;
            height: 400px;
            overflow: hidden;
            margin: 20px 0;
        }

        .before-after-slider {
            position: relative;
            width: 100%;
            height: 100%;
            margin-top: 20px;
        }

        .before, .after {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
        }

        .after {
            clip-path: inset(0 50% 0 0);
            transition: clip-path 0.3s ease;
        }

        .before img, .after img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none;
        }

        .slider-handle {
            position: absolute;
            top: 0;
            left: 50%;
            width: 5px;
            height: 100%;
            background-color: #ffffff;
            border-left: 2px solid #000;
            cursor: ew-resize;
            z-index: 2;
            transition: left 0.3s ease;
        }

        input[type="file"], input[type="button"], input[type="text"] {
            margin-top: 10px;
        }

        .album {
            display: flex;
            flex-wrap: wrap;
            margin-top: 20px;
            max-width: 640px;
        }

        .set {
            position: relative;
            margin: 10px;
            width: 150px;
            height: 100px;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid #ccc;
        }

        .set img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .set-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            color: #fff;
            text-align: center;
            font-size: 14px;
        }

        .options {
            position: absolute;
            top: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ccc;
            display: none;
            flex-direction: column;
            z-index: 3;
        }

        .options button {
            border: none;
            background: none;
            cursor: pointer;
            padding: 5px 10px;
            text-align: left;
        }

        .options button:hover {
            background-color: #f0f0f0;
        }

        .set:hover .options {
            display: flex;
        }

        .navigation {
            margin: 10px 0;
        }

        .album-selection {
            margin-bottom: 10px;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>



<div>
    <input type="text" id="new-album-name" placeholder="Nhập tên album mới" />
    <input type="button" id="create-album" value="Tạo Album">
</div>

<div class="album-selection">
    <label for="album-select">Chọn Album:</label>
    <select id="album-select">
        <option value="">--Chọn Album--</option>
    </select>
</div>


<div class="slider-container">
    <div class="before-after-slider">
        <div class="before">
            <img id="before-image" src="" alt="Ảnh Trước">
        </div>
        <div class="after">
            <img id="after-image" src="" alt="Ảnh Sau">
        </div>
        <div class="slider-handle"></div>
    </div>
</div>

<div class="navigation">
    <input type="button" id="prev-set" value="◀️" style="margin-right: 10px;">
    <span id="set-number"></span>
    <input type="button" id="next-set" value="▶️">
</div>

<input type="file" id="before-upload" accept="image/*" onchange="loadImage(event, 'before')">
<input type="file" id="after-upload" accept="image/*" onchange="loadImage(event, 'after')">
<input type="text" id="set-name" placeholder="Nhập Tên Bộ Ảnh" />
<select id="album-to-add">
    <option value="">--Chọn Album để thêm--</option>
</select>
<input type="button" id="reset" value="Đặt Lại Ảnh">
<input type="button" id="add-set" value="Thêm Bộ Ảnh">
<!-- Nút để trích xuất HTML -->
<input type="button" id="export-html" value="Trích Xuất HTML">
<div class="album" id="album"></div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js';
    import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js';
    import { getDatabase, ref as dbRef, set, get, remove } from 'https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js';

    const firebaseConfig = {
        apiKey: "AIzaSyDbVeGarGP8z52ElsyvI1wqwjyjLXSZrbc",
        authDomain: "before-after-gallery.firebaseapp.com",
        projectId: "before-after-gallery",
        storageBucket: "before-after-gallery.appspot.com",
        messagingSenderId: "347435161918",
        appId: "1:347435161918:web:5f6e3c1bbe4a59d55eb46f",
        databaseURL: "https://before-after-gallery-default-rtdb.firebaseio.com/"
    };

    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const db = getDatabase(app);

    $(document).ready(function() {
	   loadLastSelectedAlbum(); // Gọi hàm để tải album cuối cùng khi trang được tải
        let currentSetIndex = 0;
        let imageSets = [];

        var $sliderHandle = $('.slider-handle');
        var $after = $('.after');
        var sliderWidth = $('.slider-container').width();
        var isDragging = false;

        function updateSlider(offsetX) {
            $sliderHandle.css('left', offsetX);
            $after.css('clip-path', 'inset(0 ' + (sliderWidth - offsetX) + 'px 0 0)');
        }

        function onMouseMove(e) {
            if (isDragging) {
                var offsetX = e.clientX - $sliderHandle.parent().offset().left;
                offsetX = Math.max(0, Math.min(offsetX, sliderWidth));
                updateSlider(offsetX);
            }
        }

        function onTouchMove(e) {
            if (isDragging) {
                var touch = e.touches[0];
                var offsetX = touch.clientX - $sliderHandle.parent().offset().left;
                offsetX = Math.max(0, Math.min(offsetX, sliderWidth));
                updateSlider(offsetX);
            }
        }

        $sliderHandle.on('mousedown', function(e) {
            isDragging = true;
            e.preventDefault();
            $(document).on('mousemove', onMouseMove);
        });

        $(document).on('mouseup', function() {
            isDragging = false;
            $(document).off('mousemove', onMouseMove);
        });

        $sliderHandle.on('touchstart', function(e) {
            isDragging = true;
            e.preventDefault();
            $(document).on('touchmove', onTouchMove);
        });

        $(document).on('touchend', function() {
            isDragging = false;
            $(document).off('touchmove', onTouchMove);
        });

        window.loadImage = function(event, type) {
            var input = event.target;
            var reader = new FileReader();

            reader.onload = function(e) {
                if (type === 'before') {
                    $('#before-image').attr('src', e.target.result);
                } else {
                    $('#after-image').attr('src', e.target.result);
                }
                updateClipPath();
            }

            if (input.files && input.files[0]) {
                reader.readAsDataURL(input.files[0]);
            }
        };

        function updateClipPath() {
            var sliderWidth = $('.slider-container').width();
            var handlePos = $sliderHandle.position().left;
            var clipWidth = sliderWidth - handlePos;
            $after.css('clip-path', 'inset(0 ' + clipWidth + 'px 0 0)');
        }

        $('#create-album').on('click', function() {
            const albumName = $('#new-album-name').val();
            if (!albumName) {
                alert('Vui lòng nhập tên album!');
                return;
            }

            const albumRef = dbRef(db, 'albums/' + albumName);
            set(albumRef, {
                name: albumName
            }).then(() => {
                alert('Album đã được tạo thành công!');
                $('#album-select, #album-to-add').append(`<option value="${albumName}">${albumName}</option>`);
                $('#new-album-name').val(''); // Xóa nội dung sau khi tạo album
            }).catch((error) => {
                console.error('Lỗi khi tạo album:', error);
            });
        });

        $('#add-set').on('click', function() {
            const setName = $('#set-name').val();
            const albumName = $('#album-to-add').val();
            const beforeImage = $('#before-image').attr('src');
            const afterImage = $('#after-image').attr('src');

            if (!beforeImage || !afterImage || !albumName) {
                alert('Vui lòng chọn cả hai ảnh và album!');
                return;
            }

            saveSetToAlbum(albumName, setName, beforeImage, afterImage);
        });

        $('#prev-set').on('click', function() {
            if (currentSetIndex > 0) {
                currentSetIndex--;
                updateDisplayedSet();
                updateSetNumber();
            }
        });

        $('#next-set').on('click', function() {
            if (currentSetIndex < imageSets.length - 1) {
                currentSetIndex++;
                updateDisplayedSet();
                updateSetNumber();
            }
        });

        function updateDisplayedSet() {
            const set = imageSets[currentSetIndex];
            $('#before-image').attr('src', set.before);
            $('#after-image').attr('src', set.after);
            $('#set-name').val(set.name);
            updateClipPath();
        }

        function updateSetNumber() {
            $('#set-number').text((currentSetIndex + 1) + '/' + imageSets.length);
        }

        function displaySet(setName, beforeUrl, afterUrl) {
    imageSets.push({ name: setName, before: beforeUrl, after: afterUrl });
    $('#album').append(`
        <div class="set" data-set-name="${setName}">
            <img src="${beforeUrl}" alt="${setName}">
            <div class="set-name">${setName}</div>
            <div class="options">
                <button class="delete-set">Xóa</button>
            </div>
        </div>
    `);
    updateSetNumber();
}


		$('#export-html').click(function() {
            const albumName = $('#album-select').val();
            const albumData = imageSets.map(set => ({
                before: set.before,
                after: set.after,
                name: set.name
            }));

            const htmlContent = createHTMLContent(albumName, albumData);
            const blob = new Blob([htmlContent], { type: "text/html" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${albumName}.html`;
            link.click();
        });

 
 
	function createHTMLContent(albumName, sets) {
    const setsHTML = sets.map((set, index) => `
        <div class="set" id="set-${index}" style="display: ${index === 0 ? 'block' : 'none'};">
            <h3>${set.name}</h3>
            <div class="before-after-slider">
                <div class="before"><img src="${set.before}" alt="Before"></div>
                <div class="after"><img src="${set.after}" alt="After"></div>
                <div class="slider-handle"></div>
            </div>
        </div>
    `).join('');

    return `
        <!DOCTYPE html>
        <html lang="vi">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Album ${albumName}</title>
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
            <style>
                body {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    flex-direction: column;
                    margin: 0;
                    padding: 20px;
                    font-family: Arial, sans-serif;
                }
                .before-after-slider {
                    position: relative;
                    width: 640px;
                    height: 400px;
                    margin: 20px 0;
                    overflow: hidden;
                }
                .before, .after {
                    position: absolute;
                    top: 0;
                    left: 0;
                    height: 100%;
                    width: 100%;
                }
                .after {
                    clip-path: inset(0 50% 0 0);
                    transition: clip-path 0.3s ease;
                }
                .before img, .after img {
                    width: 100%;
                    height: 100%;
                    object-fit: contain;
                }
                .slider-handle {
                    position: absolute;
                    top: 0;
                    left: 50%;
                    width: 5px;
                    height: 100%;
                    background-color: #ffffff;
                    border-left: 2px solid #000;
                    cursor: ew-resize;
                    z-index: 2;
                    transition: left 0.3s ease;
                }
                .navigation {
                    margin: 10px 0;
                }
                button {
                    padding: 10px;
                    font-size: 16px;
                }
            </style>
        </head>
        <body>
            <h1>Album: ${albumName}</h1>
            <div class="album">
                ${setsHTML}
            </div>
            <div class="navigation">
                <button id="prev-set">◀️ Trước</button>
                <span id="set-number">1/${sets.length}</span>
                <button id="next-set">Sau ▶️</button>
            </div>
            <script>
                let currentSetIndex = 0;
                const sets = document.querySelectorAll('.set');
                const setNumber = document.getElementById('set-number');

                function updateDisplayedSet() {
                    sets.forEach((set, index) => {
                        set.style.display = (index === currentSetIndex) ? 'block' : 'none';
                    });
                    setNumber.textContent = (currentSetIndex + 1) + '/' + sets.length;
                }

                document.getElementById('prev-set').addEventListener('click', () => {
                    if (currentSetIndex > 0) {
                        currentSetIndex--;
                        updateDisplayedSet();
                    }
                });

                document.getElementById('next-set').addEventListener('click', () => {
                    if (currentSetIndex < sets.length - 1) {
                        currentSetIndex++;
                        updateDisplayedSet();
                    }
                });

                // Phần trượt ảnh bằng jQuery
                $(function() {
                    var $sliderHandle = $('.slider-handle');
                    var $after = $('.after');
                    var sliderWidth = $('.before-after-slider').width();
                    var isDragging = false;

                    function updateSlider(offsetX) {
                        $sliderHandle.css('left', offsetX);
                        $after.css('clip-path', 'inset(0 ' + (sliderWidth - offsetX) + 'px 0 0)');
                    }

                    $sliderHandle.on('mousedown touchstart', function(e) {
                        isDragging = true;
                        e.preventDefault();
                        $(document).on('mousemove touchmove', function(event) {
                            var offsetX = (event.clientX || event.originalEvent.touches[0].clientX) - $sliderHandle.parent().offset().left;
                            offsetX = Math.max(0, Math.min(offsetX, sliderWidth));
                            updateSlider(offsetX);
                        });
                    });

                    $(document).on('mouseup touchend', function() {
                        isDragging = false;
                        $(document).off('mousemove touchmove');
                    });
                });
            </script>
        </body>
        </html>
    `;
}



        function saveSetToAlbum(albumName, setName, beforeImage, afterImage) {
            const setRef = dbRef(db, 'albums/' + albumName + '/sets/' + setName);
            set(setRef, {
                before: beforeImage,
                after: afterImage
            }).then(() => {
                displaySet(setName, beforeImage, afterImage);
                currentSetIndex = imageSets.length - 1;
                updateDisplayedSet();
            }).catch((error) => {
                console.error('Lỗi khi lưu bộ ảnh:', error);
            });
        }

        $('#album').on('click', '.set', function() {
            const setName = $(this).data('set-name');
            const setIndex = imageSets.findIndex(set => set.name === setName);
            if (setIndex !== -1) {
                currentSetIndex = setIndex;
                updateDisplayedSet();
            }
        });

        $('#album').on('click', '.delete-set', function() {
    const setElement = $(this).closest('.set');
    const setName = setElement.data('set-name');

    const setRef = dbRef(db, 'albums/' + $('#album-select').val() + '/sets/' + setName); // Chỉnh sửa đường dẫn đến bộ ảnh
    remove(setRef).then(() => {
        setElement.remove();
        const setIndex = imageSets.findIndex(set => set.name === setName);
        if (setIndex !== -1) {
            imageSets.splice(setIndex, 1);
            if (currentSetIndex >= setIndex) {
                currentSetIndex = Math.max(0, currentSetIndex - 1);
            }
            updateDisplayedSet();
            updateSetNumber();
        }
    }).catch((error) => {
        console.error('Lỗi khi xóa bộ ảnh:', error);
    });
});


        function loadSetsFromDatabase() {
            const setsRef = dbRef(db, 'sets');
            get(setsRef).then((snapshot) => {
                if (snapshot.exists()) {
                    const sets = snapshot.val();
                    $.each(sets, function(setName, urls) {
                        if (urls && typeof urls === 'object' && urls.before && urls.after) {
                            displaySet(setName, urls.before, urls.after);
                        } else {
                            console.error('Bộ ảnh không hợp lệ: ', setName);
                        }
                    });
                    currentSetIndex = 0;
                    updateDisplayedSet();
                    updateSetNumber();
                } else {
                    console.log('Không tìm thấy bộ ảnh nào.');
                }
            }).catch((error) => {
                console.error('Lỗi khi tải bộ ảnh:', error);
            });
        }

        loadSetsFromDatabase();
        loadAlbums();

       $('#album-select').on('change', function() {
    const selectedAlbum = $(this).val();
    if (selectedAlbum) {
        // Lưu album đã chọn vào Firebase
        const lastAlbumRef = dbRef(db, 'lastSelectedAlbum');
        set(lastAlbumRef, selectedAlbum).then(() => {
            console.log('Album cuối cùng đã được lưu.');
        }).catch((error) => {
            console.error('Lỗi khi lưu album cuối cùng: ', error);
        });
        
        loadSetsForAlbum(selectedAlbum); // Tải các bộ ảnh cho album đã chọn
    }
});

function loadLastSelectedAlbum() {
    const lastAlbumRef = dbRef(db, 'lastSelectedAlbum');
    get(lastAlbumRef).then((snapshot) => {
        if (snapshot.exists()) {
            const lastSelectedAlbum = snapshot.val();
            if (lastSelectedAlbum) {
                $('#album-select').val(lastSelectedAlbum); // Chọn album trên dropdown
                loadSetsForAlbum(lastSelectedAlbum); // Tải các bộ ảnh cho album
                console.log('Album cuối cùng đã được tải: ' + lastSelectedAlbum);
            }
        } else {
            console.log('Chưa có album nào được chọn.');
        }
    }).catch((error) => {
        console.error('Lỗi khi tải album cuối cùng: ', error);
    });
}



        function loadAlbums() {
            const albumRef = dbRef(db, 'albums');
            get(albumRef).then(snapshot => {
                if (snapshot.exists()) {
                    const albums = snapshot.val();
                    $.each(albums, function(albumName) {
                        $('#album-select, #album-to-add').append(`<option value="${albumName}">${albumName}</option>`);
                    });
                } else {
                    console.log('Không tìm thấy album nào.');
                }
            }).catch(error => {
                console.error('Lỗi khi tải album: ', error);
            });
        }

        function loadSetsForAlbum(albumName) {
            const setsRef = dbRef(db, `albums/${albumName}/sets`);
            get(setsRef).then(snapshot => {
                if (snapshot.exists()) {
                    const sets = snapshot.val();
                    $('#album').empty(); 
                    imageSets = []; 

                    $.each(sets, function(setName, urls) {
                        if (urls && typeof urls === 'object' && urls.before && urls.after) {
                            displaySet(setName, urls.before, urls.after);
                        } else {
                            console.error('Bộ ảnh không hợp lệ: ', setName);
                        }
                    });
                    currentSetIndex = 0; 
                    updateDisplayedSet(); 
                    updateSetNumber(); 
                } else {
                    console.log('Album không có bộ ảnh nào.');
                }
            }).catch(error => {
                console.error('Lỗi khi tải bộ ảnh cho album: ', error);
            });
        }
    });
</script>

</body>
</html>
